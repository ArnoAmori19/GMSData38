SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[tf_ProdRecs](@appOurID int, @appStockID int, @ProdID int)/* Возвращает приходы товара на указанную фирму и склад в обратном порядке */RETURNS @out table(SrcPosID int identity, DocDate datetime, PPID int, Qty numeric(21,9))Begin  INSERT INTO @OUT (DocDate, PPID, Qty)  SELECT DocDate, PPID, Qty FROM t_Rec a WITH (NOLOCK) INNER JOIN t_RecD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT DocDate, PPID, Qty FROM t_Cst a WITH (NOLOCK) INNER JOIN t_CstD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT DocDate, PPID, Qty FROM t_Ret a WITH (NOLOCK) INNER JOIN t_RetD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT DocDate, PPID, Qty FROM t_CRRet a WITH (NOLOCK) INNER JOIN t_CRRetD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT DocDate, PPID, Qty FROM t_Exc a WITH (NOLOCK) INNER JOIN t_ExcD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND NewStockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT DocDate, NewPPID As PPID, Qty FROM t_Est a WITH (NOLOCK) INNER JOIN t_EstD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT DocDate, PPID, NewQty AS Qty FROM t_Ven a WITH (NOLOCK) INNER JOIN t_VenD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND DetProdID=@ProdID  UNION All  SELECT DocDate, PPID, Qty FROM t_SRec a WITH (NOLOCK) INNER JOIN t_SRecA b WITH (NOLOCK) ON a.ChID=b.ChID WHERE OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  UNION All  SELECT SubDocDate AS DocDate, SubPPID AS PPID, SubQty AS Qty FROM (t_SExp a WITH (NOLOCK) INNER JOIN t_SExpA t WITH (NOLOCK) ON a.ChID=t.ChID) INNER JOIN t_SExpD b WITH (NOLOCK) ON t.AChID = b.AChID WHERE OurID=@appOurID AND SubStockID=@appStockID AND SubProdID=@ProdID  UNION All  SELECT '1/1/1990' AS DocDate, PPID, Qty FROM t_zInP WITH (NOLOCK) WHERE OurID=@appOurID AND StockID=@appStockID AND ProdID=@ProdID  ORDER BY DocDate DESC  RETURNEnd 
GO
