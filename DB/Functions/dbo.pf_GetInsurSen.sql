SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[pf_GetInsurSen] (@DocDate datetime, @EmpID int, @OurID int)/* Возвращает страховой стаж */RETURNS @out TABLE (InsurSenYears int, InsurSenMonths int, InsurSenDays int)ASBEGIN  DECLARE @BDate datetime,          @InsurSenYears int,          @InsurSenMonths int,          @InsurSenDays int  SET @InsurSenYears = 0  SET @InsurSenMonths = 0  SET @InsurSenDays = 0  IF EXISTS (SELECT 1 FROM r_EmpMO WHERE EmpID = @EmpID AND OurID = @OurID)    BEGIN     SELECT @InsurSenYears = InsurSenYears, @InsurSenMonths = InsurSenMonths, @InsurSenDays = InsurSenDays FROM r_EmpMO WHERE EmpID=@EmpID AND OurID=@OurID     SET @BDate = dbo.pf_GetEmpGivDate(@DocDate, @EmpID, @OurID)       IF @BDate > '1/1/1900'         BEGIN           SET @InsurSenDays = @InsurSenDays + (DAY(@DocDate) - DAY(@BDate))           IF @InsurSenDays >= DAY(dbo.zf_GetMonthLastDay(@DocDate))            BEGIN              SET @InsurSenMonths = @InsurSenMonths + 1              SET @InsurSenDays = @InsurSenDays - DAY(dbo.zf_GetMonthLastDay(@DocDate))            END          ELSE IF @InsurSenDays < 1            BEGIN              SET @InsurSenMonths = @InsurSenMonths - 1              SET @InsurSenDays = @InsurSenDays + DAY(dbo.zf_GetMonthLastDay(@DocDate))            END          SET @InsurSenMonths = @InsurSenMonths + (MONTH(@DocDate) - MONTH(@BDate))          IF @InsurSenMonths >= 12            BEGIN              SET @InsurSenYears = @InsurSenYears + 1              SET @InsurSenMonths = @InsurSenMonths - 12            END          ELSE IF @InsurSenMonths < 1            BEGIN              SET @InsurSenYears = @InsurSenYears - 1              SET @InsurSenMonths = @InsurSenMonths + 12            END          SET @InsurSenYears = @InsurSenYears +  (YEAR(@DocDate) - YEAR(@BDate))       END    END  INSERT INTO @out (InsurSenYears, InsurSenMonths, InsurSenDays)  SELECT @InsurSenYears, @InsurSenMonths, @InsurSenDays  RETURNEND
GO
