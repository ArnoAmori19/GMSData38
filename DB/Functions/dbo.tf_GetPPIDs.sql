SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[tf_GetPPIDs](@appPP int, @appOurID int, @appStockID int, @appSecID int, @ProdID int)/* Возвращает партию для указанного метода списания, фирмы, склада, секции и товара */RETURNS @out table(SrcPosID int identity, DocDate datetime, PPID int, Qty numeric(21,9))Begin      IF @appPP=0            INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT DocDate, PPID, Qty FROM t_Rec a WITH (NOLOCK) INNER JOIN t_RecD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_Cst a WITH (NOLOCK) INNER JOIN t_CstD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_Ret a WITH (NOLOCK) INNER JOIN t_RetD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_CRRet a WITH (NOLOCK) INNER JOIN t_CRRetD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_Exc a WITH (NOLOCK) INNER JOIN t_ExcD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND NewStockID=@appStockID AND NewSecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, NewPPID As PPID, Qty FROM t_Est a WITH (NOLOCK) INNER JOIN t_EstD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All         SELECT DocDate, PPID, NewQty AS Qty FROM t_Ven a WITH (NOLOCK) INNER JOIN t_VenD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND DetProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_SRec a WITH (NOLOCK) INNER JOIN t_SRecA b WITH (NOLOCK) ON a.ChID=b.ChID WHERE OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT SubDocDate AS DocDate, SubPPID AS PPID, SubQty AS Qty FROM (t_SExp a WITH (NOLOCK) INNER JOIN t_SExpA t WITH (NOLOCK) ON a.ChID=t.ChID) INNER JOIN t_SExpD b WITH (NOLOCK) ON t.AChID = b.AChID WHERE OurID=@appOurID AND SubStockID=@appStockID AND SubSecID=@appSecID AND SubProdID=@ProdID        UNION All        SELECT '1/1/1990' AS DocDate, PPID, Qty FROM t_zInP WITH (NOLOCK) WHERE OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        ORDER BY DocDate ASC, PPID ASC      Else      IF @appPP=1         INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT DocDate, PPID, Qty FROM t_Rec a WITH (NOLOCK) INNER JOIN t_RecD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_Cst a WITH (NOLOCK) INNER JOIN t_CstD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_Ret a WITH (NOLOCK) INNER JOIN t_RetD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_CRRet a WITH (NOLOCK) INNER JOIN t_CRRetD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_Exc a WITH (NOLOCK) INNER JOIN t_ExcD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND NewStockID=@appStockID AND NewSecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, NewPPID As PPID, Qty FROM t_Est a WITH (NOLOCK) INNER JOIN t_EstD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT DocDate, PPID, NewQty AS Qty FROM t_Ven a WITH (NOLOCK) INNER JOIN t_VenD b WITH (NOLOCK) ON a.ChID=b.ChID WHERE  OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND DetProdID=@ProdID        UNION All        SELECT DocDate, PPID, Qty FROM t_SRec a WITH (NOLOCK) INNER JOIN t_SRecA b WITH (NOLOCK) ON a.ChID=b.ChID WHERE OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        UNION All        SELECT SubDocDate AS DocDate, SubPPID AS PPID, SubQty AS Qty FROM (t_SExp a WITH (NOLOCK) INNER JOIN t_SExpA t WITH (NOLOCK) ON a.ChID=t.ChID) INNER JOIN t_SExpD b WITH (NOLOCK) ON t.AChID = b.AChID WHERE OurID=@appOurID AND SubStockID=@appStockID AND SubSecID=@appSecID AND SubProdID=@ProdID        UNION All        SELECT '1/1/1990' AS DocDate, PPID, Qty FROM t_zInP WITH (NOLOCK) WHERE OurID=@appOurID AND StockID=@appStockID AND SecID=@appSecID AND ProdID=@ProdID        ORDER BY DocDate DESC, PPID DESC      Else      IF @appPP=2        INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT '1/1/1990', m.PPID, d.Qty AS ARem FROM t_PInP m, t_Rem d WITH (NOLOCK)                                                   WHERE d.Qty>0 AND d.ProdID=m.ProdID AND d.PPID=m.PPID AND                				   d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID					                				   ORDER BY m.PriceMC_In ASC, m.PPID ASC					      Else      IF @appPP=3         INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT '1/1/1990', m.PPID, d.Qty AS ARem FROM t_PInP m, t_Rem d WITH (NOLOCK)                 				   WHERE d.Qty>0 AND d.ProdID=m.ProdID AND d.PPID=m.PPID AND					                         			   d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID						                                                   ORDER BY m.PriceMC_In DESC, m.PPID DESC      Else      IF @appPP=4         INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT /* DISTINCT */ '1/1/1990', m.PPID AS PPID, d.Qty AS ARem FROM t_PInP m, t_Rem d WITH (NOLOCK)            					   WHERE d.Qty>0 AND d.ProdID=m.ProdID AND d.PPID=m.PPID AND				            					   d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID				                                                   ORDER BY m.Priority ASC, m.PPID ASC      Else       IF @appPP=6        INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT '1/1/1990', m.PPID, d.Qty AS ARem FROM t_PInP m, t_Rem d WITH (NOLOCK)        					   WHERE d.Qty>0 AND d.ProdID=m.ProdID AND d.PPID=m.PPID AND				         					   d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID				                                                   ORDER BY m.ProdDate ASC, m.PPID ASC      Else      IF @appPP=7         INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT '1/1/1990', m.PPID, d.Qty AS ARem FROM t_PInP m, t_Rem d WITH (NOLOCK)        					   WHERE d.Qty>0 AND d.ProdID=m.ProdID AND d.PPID=m.PPID AND				        					   d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID				                                                   ORDER BY m.ProdDate DESC, m.PPID DESC      Else       IF @appPP=8         INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT '1/1/1990', d.PPID, d.Qty AS ARem FROM t_Rem d WITH (NOLOCK)                                                                 WHERE d.Qty>0 AND d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID                                                                ORDER BY d.PPID ASC      Else      IF @appPP=9         INSERT INTO @OUT (DocDate, PPID, Qty)        SELECT '1/1/1990', d.PPID, d.Qty AS ARem FROM t_Rem d WITH (NOLOCK)                                                                 WHERE d.Qty>0 AND d.OurID=@appOurID AND d.StockID=@appStockID AND d.ProdID=@ProdID AND d.SecID=@appSecID                                                                ORDER BY d.PPID DESC  RETURNEnd 
GO
