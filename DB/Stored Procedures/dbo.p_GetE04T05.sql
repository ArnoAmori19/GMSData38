SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[p_GetE04T05](@OurID int, @Date smalldatetime)/* Возвращает данные таблицы E04T05 (экспорт в "АРМ Звіт страхувальника") */ASBEGIN  SET NOCOUNT ON  DECLARE @PeriodBegin smalldatetime, @PeriodEnd smalldatetime, @PeriodM int, @PeriodY int  SET @PeriodBegin = dbo.zf_GetDate(dbo.zf_GetMonthFirstDay(@Date))  SET @PeriodEnd = dbo.zf_GetDate(dbo.zf_GetMonthLastDay(@Date))  SET @PeriodY = DATEPART(yyyy, @Date)  SET @PeriodM = DATEPART(mm, @Date)  /* выборка принятых и уволенных служащих в отчетном периоде */  DECLARE @EmpMPst TABLE (OurID int, EmpID int, BDate smalldatetime, EDate smalldatetime)  INSERT INTO @EmpMPst(OurID, EmpID, BDate, EDate)  SELECT OurID, EmpID, MIN(CASE WHEN IsGivDoc = 1 THEN BDate ELSE NULL END), MAX(CASE WHEN IsDisDoc = 1 THEN EDate ELSE NULL END )  FROM   r_EmpMPst s  WHERE  s.OurID = @OurID AND BDate BETWEEN @PeriodBegin AND @PeriodEnd AND (IsDisDoc = 1 OR IsGivDoc = 1)  GROUP BY OurID, EmpID  /* результирующий набор */  SELECT  CASE WHEN e.TaxCode = '' THEN ISNULL(n.PassSer, e.PassSer) + ' ' + ISNULL(n.PassNo, e.PassNo)               ELSE e.TaxCode          END AS TaxCode,          e.IsCitizen,          ISNULL(n.UAEmpLastName, e.UAEmpLastName) AS UAEmpLastName,          ISNULL(n.UAEmpFirstName, e.UAEmpFirstName) AS UAEmpFirstName,          ISNULL(n.UAEmpParName, e.UAEmpParName) AS UAEmpParName,          DATEPART(dd, CASE WHEN s.BDate >= @PeriodBegin THEN s.BDate                            ELSE NULL                       END)	AS BDay,          DATEPART(dd, CASE WHEN s.EDate <= @PeriodEnd THEN s.EDate                            ELSE NULL                       END)	AS EDay,          @PeriodM AS PeriodM,          @PeriodY AS PeriodY  FROM    @EmpMPst s          INNER JOIN r_Emps e ON e.EmpID = s.EmpID          LEFT  JOIN r_EmpNamesDates n ON n.OurID = @OurID                                          AND n.EmpID = s.EmpID                                          AND s.BDate BETWEEN n.BDate AND n.EDateEND
GO
