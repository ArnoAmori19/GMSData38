SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[t_GetCRProdInfo](@CRID smallint, @ProdID int, @PriceCC varchar(200), @TaxID int, @CheckPrice bit, @ProdName varchar(200), @CashProdID int output, @DecimalQty bit output, @Result bit output) AS/* Возвращает CashProdID и DecimalQty для продажи товара через ЭККА */BEGIN  DECLARE @v int  DECLARE @BarCode varchar(50)  SET @Result = 0  SELECT @DecimalQty = ISNULL(IsDecQty, 0) FROM r_Prods WHERE ProdID = @ProdID  SELECT @BarCode = ISNULL(q.BarCode, '') FROM r_Prods p WITH(NOLOCK), r_ProdMQ q WITH(NOLOCK) WHERE p.ProdID = q.ProdID AND p.UM = q.UM AND p.ProdID = @ProdID  IF (@CheckPrice = 1)    IF EXISTS(SELECT CRProdID FROM r_CRMP WHERE CRID = @CRID AND ProdID = @ProdID AND CRProdName = @ProdName AND PriceCC = @PriceCC AND TaxID = @TaxID AND DecimalQty = @DecimalQty)      SELECT @v = CRProdID FROM r_CRMP WHERE CRID = @CRID AND ProdID = @ProdID AND CRProdName = @ProdName AND PriceCC = @PriceCC AND TaxID = @TaxID AND DecimalQty = @DecimalQty    ELSE      BEGIN        SET @v = ISNULL((SELECT (MAX(CRProdID) + 1) FROM r_CRMP WHERE CRID = @CRID), 1)        INSERT INTO r_CRMP(CRID, ProdID, CRProdName, CRProdID, TaxID, SecID, FixedPrice, PriceCC, DecimalQty, BarCode)        VALUES (@CRID, @ProdID, @ProdName, @v, @TaxID, 1, 0, @PriceCC, @DecimalQty, @BarCode)        SET @Result = 1      END  ELSE    IF EXISTS(SELECT CRProdID FROM r_CRMP WHERE CRID = @CRID AND ProdID = @ProdID AND CRProdName = @ProdName AND TaxID = @TaxID AND DecimalQty = @DecimalQty)      SELECT @v = CRProdID FROM r_CRMP WHERE CRID = @CRID AND ProdID = @ProdID AND CRProdName = @ProdName AND TaxID = @TaxID AND DecimalQty = @DecimalQty    ELSE      BEGIN        SET @v = ISNULL((SELECT (MAX(CRProdID) + 1) FROM r_CRMP WHERE CRID = @CRID), 1)        INSERT INTO r_CRMP(CRID, ProdID, CRProdName, CRProdID, TaxID, SecID, FixedPrice, PriceCC, DecimalQty, BarCode)        VALUES (@CRID, @ProdID, @ProdName, @v, @TaxID, 1, 0, @PriceCC, @DecimalQty, @BarCode)        SET @Result = 1      END  SET @CashProdID = @vEND
GO
