SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO
CREATE PROCEDURE [dbo].[t_SaleSrvGetProdsDiff](@CRID int, @MainUM bit, @RefreshOnly bit = 0)/* Формирует список новых и изменившихся товаров для выгрузки в ЭККА */ASBEGIN  SET NOCOUNT ON  SET XACT_ABORT ON  CREATE TABLE #SaleSrv_GetProdsDiff  (    ProdID int,    ProdName varchar(200),    PriceCC_wt numeric(21, 9),    Qty numeric(21, 9),    SecID int,    ProdDep int,    ProdGroup int,    TaxID int,    CanEditPrice bit,    ProdType int,    IsDecQty bit,    CheckRem bit,    BarCode varchar(42),    UM varchar(50),    MainUM bit,    CRProdID int  )  INSERT INTO #SaleSrv_GetProdsDiff  EXECUTE t_SaleSrvGetProds @CRID, @MainUM  IF @RefreshOnly = 1      DELETE    FROM #SaleSrv_GetProdsDiff    FROM #SaleSrv_GetProdsDiff c    WHERE c.ProdID NOT IN (SELECT r.ProdID FROM r_CRMP r WHERE r.CRID = @CRID AND r.Barcode = c.BarCode)  DELETE  FROM #SaleSrv_GetProdsDiff  FROM #SaleSrv_GetProdsDiff d    INNER JOIN r_CRMP p ON d.ProdID = p.ProdID AND d.ProdName = p.CRProdName AND d.PriceCC_wt = p.PriceCC AND      d.SecID = p.SecID AND d.TaxID = p.TaxID AND d.BarCode = p.BarCode AND p.CRID = @CRID  SELECT r.*, c.ProdNameC, c.TaxIDC  FROM #SaleSrv_GetProdsDiff r    LEFT OUTER JOIN      (        SELECT  d.ProdID, d.BarCode,           CASE WHEN d.ProdName = p.CRProdName THEN 0 ELSE 1 END AS ProdNameC,          CASE WHEN d.TaxID = p.TaxID THEN 0 ELSE 1 END AS TaxIDC       FROM #SaleSrv_GetProdsDiff d, r_CRMP p       WHERE d.ProdID = p.ProdID AND p.CRID = @CRID AND d.BarCode = p.BarCode      ) c  ON r.ProdID = c.ProdID AND r.BarCode = c.BarCode  ORDER BY r.MainUM DESC, r.ProdIDEND
GO
