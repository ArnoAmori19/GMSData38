SET QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[tf_GetFreeCRProdID](@CRID int, @StockID int, @Capacity int, @GetLast bit = 0, @UseCRProdID bit = 0)/* Возвращает свободный код товара для ЭККА */RETURNS intASBEGIN  RETURN      CASE @GetLast WHEN 1 THEN         (          SELECT (MAX(r1.CRProdID) - 1)          FROM           (            SELECT @Capacity + 1 CRProdID             UNION            SELECT CRProdID FROM r_StockCRProds WHERE StockID = @StockID AND @UseCRProdID = 1            UNION            SELECT CRProdID FROM r_CRMP WHERE CRID = @CRID          ) r1          LEFT JOIN           (            SELECT CRProdID FROM r_StockCRProds WHERE StockID = @StockID AND @UseCRProdID = 1            UNION            SELECT CRProdID FROM r_CRMP WHERE CRID = @CRID          ) r2          ON r1.CRProdID = r2.CRProdID + 1          WHERE r2.CRProdID IS NULL AND r1.CRProdID <= @Capacity + 1         )      ELSE        (          SELECT (MIN(r1.CRProdID) + 1)          FROM           (            SELECT 0 CRProdID             UNION            SELECT CRProdID FROM r_StockCRProds WHERE StockID = @StockID AND @UseCRProdID = 1            UNION            SELECT CRProdID FROM r_CRMP WHERE CRID = @CRID          ) r1          LEFT JOIN           (             SELECT CRProdID FROM r_StockCRProds WHERE StockID = @StockID AND @UseCRProdID = 1            UNION            SELECT CRProdID FROM r_CRMP WHERE CRID = @CRID          ) r2          ON r1.CRProdID = r2.CRProdID - 1          WHERE r2.CRProdID IS NULL AND r1.CRProdID <= @Capacity        )      ENDEND
GO