SET QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[bf_GetNewGPosID](@OurID int, @DocDate datetime)/* Возвращает порядковый номер документа для расчета первого события */RETURNS INT ASBEGIN  DECLARE @v1 INT, @v2 INT  SET @v1 = 0  SET @v2 = 0  /* Расчетный счет: Приход */  SET @v2 = (SELECT MAX(GPosID) FROM b_BankRecCC WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Расчетный счет: Расход */  SET @v2 = (SELECT MAX(GPosID) FROM b_BankExpCC WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Валютный счет: Приход */  SET @v2 = (SELECT MAX(GPosID) FROM b_BankRecAC WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Валютный счет: Расход */  SET @v2 = (SELECT MAX(GPosID) FROM b_BankExpAC WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Кассовый ордер: Приход */  SET @v2 = (SELECT MAX(GPosID) FROM b_CRec WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Кассовый ордер: Расход */  SET @v2 = (SELECT MAX(GPosID) FROM b_CExp WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Приход по накладной (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_Rec WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Возврат от получателя (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_Ret WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Расходная накладная (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_Inv WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Внутренний расход (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_Exp WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Возврат поставщику (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_CRet WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Приход по ГТД (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_Cst WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Расход по ГТД (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_CInv WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* ТМЦ: Суммовой учет */  SET @v2 = (SELECT MAX(GPosID) FROM b_DStack WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Основные средства: Приход (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_SRec WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Основные средства: Ремонт (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_SRep WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Основные средства: Продажа (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_SInv WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Основные средства: Списание (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_SExp WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Акт приемки услуг */  SET @v2 = (SELECT MAX(GPosID) FROM b_ARec WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Акт сдачи услуг */  SET @v2 = (SELECT MAX(GPosID) FROM b_AExp WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Авансовый отчет с признаками (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_CRepA WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Авансовый отчет валютный (Заголовок) */  SET @v2 = (SELECT MAX(GPosID) FROM b_ARepA WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Проводка по предприятию */  SET @v2 = (SELECT MAX(GPosID) FROM b_TranC WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Налоговые накладные: Входящие */  SET @v2 = (SELECT MAX(GPosID) FROM b_TRec WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  /* Налоговые накладные: Исходящие */  SET @v2 = (SELECT MAX(GPosID) FROM b_TExp WHERE OurID = @OurID AND DocDate = @DocDate)  IF @v2 > @v1 SET @v1 = @v2  RETURN @v1 + 1END
GO