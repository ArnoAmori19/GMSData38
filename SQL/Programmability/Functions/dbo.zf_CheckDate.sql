SET QUOTED_IDENTIFIER, ANSI_NULLS ON
GO
CREATE FUNCTION [dbo].[zf_CheckDate](@DateTime datetime, @cron varchar (4000)) /* Определяет, соответствует ли дата шаблону.   Возвращает 1 если строка @cron (формат Cron)   соответствует дате и времени @DateTime. Иначе - возвращает 0   6-я группа крона - год в диапазоне 0-79 */RETURNS INT ASBEGIN  DECLARE  @datepart int, @cronpart varchar(4000), @cronpart2 varchar(4000), @col int, @maxdp int, @j int, @j2 int, @i int,  @i1 int, @i2 int, @s varchar(4000)  WHILE (CHARINDEX('  ', @cron) > 0) SET @cron = REPLACE(@cron, '  ', ' ')  SET @cron = @cron + ' '  SET @col = 1  WHILE (@col <= 6) AND (@cron <> '')    BEGIN        SET @j = CHARINDEX(' ', @cron)      IF @j = 0 BREAK      SET @cronpart = LTRIM(SUBSTRING(@cron, 1, @j - 1))      IF (@cronpart <> '*') AND (@cronpart <> '')        BEGIN            /* получение сравниваемой части даты и установка максимального значения в группе */          IF @col = 1 BEGIN SET @datepart = DATEPART(mi,@DateTime) SET @maxdp = 59  END          ELSE IF @col = 2 BEGIN SET @datepart = DATEPART(hh,@DateTime) SET @maxdp = 23  END          ELSE IF @col = 3 BEGIN SET @datepart = DATEPART(d,@DateTime)  SET @maxdp = 31  END          ELSE IF @col = 4 BEGIN SET @datepart = DATEPART(m,@DateTime)  SET @maxdp = 12  END          ELSE IF @col = 5 BEGIN SET @datepart = (DATEPART(dw,@DateTime)+@@DATEFIRST - 1)%7 IF @datepart = 0 SET @datepart = 7 SET @maxdp = 7 END          ELSE IF @col = 6 BEGIN SET @datepart = DATEPART(yy,@DateTime) - 2000 SET @maxdp = 79  END          /* --- начало --- разворачивание прогрессий */          /*  1,10,20/3 ==> 1,10,20,23,26,29...@maxdp */          IF CHARINDEX('/', @cronpart) > 0            BEGIN              SET @cronpart2 = @cronpart + ','              SET @cronpart = ''              WHILE (1 = 1)                BEGIN                  SET @i = CHARINDEX(',', @cronpart2)                  IF @i = 0 BREAK                  SET @s = SUBSTRING(@cronpart2, 1, @i - 1)                  IF @s = '' RETURN 0                  SET @j2 = CHARINDEX('/', @s)                  IF @j2 > 0                    BEGIN                      SET @i1 = CAST(REPLACE(SUBSTRING(@s, 1, @j2 - 1), '*', '0') AS int)                      SET @i2 = CAST(SUBSTRING(@s, @j2+1, 2) AS int)                      WHILE @i1 <= @maxdp                        BEGIN                          SET @cronpart = @cronpart + CAST(@i1 AS varchar(10))+ ','                          SET @i1 = @i1 + @i2                        END                    END                  ELSE SET @cronpart = @cronpart  + @s + ','                  SET @cronpart2 = SUBSTRING(@cronpart2, @i + 1, 4000)                END            END            /* --- окончание --- разворачивание прогрессий */          IF dbo.zf_MatchFilterInt(@datepart, @cronpart, ',') <> 1  RETURN 0        END      SET @col = @col + 1      SET @cron = SUBSTRING(@cron, @j+1, 4000)    END  RETURN 1END
GO